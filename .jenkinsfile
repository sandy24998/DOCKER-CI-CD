pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                checkout scm // Jenkins automatically checks out the source code 
            }
        }
        stage('Clean Up') {
            steps {
                // Stop and remove the running container
                sh '''
                        docker ps -a -q --filter "name=flask-app" | xargs -r docker stop
                        docker ps -a -q --filter "name=flask-app" | xargs -r docker rm -f
                        docker images -q flask-app:latest | xargs -r docker rmi -f
                '''
            }
        }
        stage('Docker Build') {
            steps {
                sh 'docker build -t flask-app:latest .' 
            }
        }
        stage('Push to Dockerhub') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'DockerHubCred', 
                    usernameVariable: 'DOCKER_USER', 
                    passwordVariable: 'DOCKER_PASS'
                )]) {
                    sh '''
                        docker login -u $DOCKER_USER -p $DOCKER_PASS
                        docker image tag flask-app:latest $DOCKER_USER/flask-app:latest
                        docker push $DOCKER_USER/flask-app:latest
                    '''
                }
            }
        }
        stage('Deploy') {
            steps {
                sh 'docker-compose down && docker-compose up -d'
            }
        }
    }
}
